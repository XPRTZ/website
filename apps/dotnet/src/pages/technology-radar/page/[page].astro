---
import type { GetStaticPaths } from "astro";
import { fetchData, type RadarItem, type Page as PageType } from "@xprtz/cms";
import Layout from "../../../layouts/layout.astro";
import { Container, RadarChart, ComponentRenderer } from "@xprtz/ui";

export const getStaticPaths: GetStaticPaths = async () => {
  // Generate a single page for the radar
  return [{ params: { page: "1" } }];
};

const site = import.meta.env.PUBLIC_SITE || "no-site-found";
const radarPages = await fetchData<Array<PageType>>({
  endpoint: "pages",
  wrappedByKey: "data",
  query: {
    "filters[site][$eq]": site,
    "filters[slug][$eq]": "technology-radar",
    "populate[components]": "*",
    status: "published",
  },
});

const radarPage = radarPages[0];

// Fetch all radar items for the chart
const allRadarItems = await fetchData<Array<RadarItem>>({
  endpoint: "radar-items",
  wrappedByKey: "data",
  query: {
    "populate[tags][fields][0]": "title",
    status: "published",
  },
});

// Extract all unique tags from radar items
const allTags = Array.from(
  new Set(
    allRadarItems
      .flatMap(item => item.tags || [])
      .map(tag => tag.title)
  )
).sort();
---

<Layout
  title={radarPage.title_website}
  description={radarPage.description}
>
  <Container>
    <svg
      class="absolute inset-x-0 top-0 -z-10 h-[64rem] w-full stroke-gray-200 [mask-image:radial-gradient(32rem_32rem_at_center,white,transparent)]"
      aria-hidden="true"
    >
      <defs>
        <pattern
          id="1f932ae7-37de-4c0a-a8b0-a6e3b4d44b84"
          width={200}
          height={200}
          x="50%"
          y={-1}
          patternUnits="userSpaceOnUse"
        >
          <path d="M.5 200V.5H200" fill="none"></path>
        </pattern>
      </defs>
      <svg x="50%" y={-1} class="overflow-visible fill-gray-50">
        <path
          d="M-200 0h201v201h-201Z M600 0h201v201h-201Z M-400 600h201v201h-201Z M200 800h201v201h-201Z"
          stroke-width={0}></path>
      </svg>
      <rect
        width="100%"
        height="100%"
        stroke-width={0}
        fill="url(#1f932ae7-37de-4c0a-a8b0-a6e3b4d44b84)"></rect>
    </svg>

    <div
      class="absolute left-1/2 right-0 top-0 -z-10 -ml-24 transform-gpu overflow-hidden blur-3xl lg:ml-24 xl:ml-48"
      aria-hidden="true"
    >
      <div
        class="aspect-[801/1036] w-[50.0625rem] bg-gradient-to-tr from-primary-100 to-primary-800 opacity-30"
        style="clip-path: polygon(63.1% 29.5%, 100% 17.1%, 76.6% 3%, 48.4% 0%, 44.6% 4.7%, 54.5% 25.3%, 59.8% 49%, 55.2% 57.8%, 44.4% 57.2%, 27.8% 47.9%, 35.1% 81.5%, 0% 97.7%, 39.2% 100%, 35.2% 81.4%, 97.2% 52.8%, 63.1% 29.5%);"
      >
      </div>
    </div>
    <div class="overflow-hidden">
      <div class="mx-auto max-w-7xl px-6 pt-36 sm:pt-60 lg:px-8 lg:pt-32">
        <div
          class="mx-auto max-w-2xl gap-x-14 lg:mx-0 lg:max-w-none lg:items-center"
        >
          <p class="text-base/7 font-semibold text-primary-600">
            {radarPage.tagline}
          </p>
          <h1
            class="mt-2 text-pretty text-4xl font-semibold tracking-tight text-primary-800 sm:text-5xl"
          >
            {radarPage.title_website}
          </h1>
          <p class="mt-6 text-xl/8">{radarPage.description}</p>
          <div class="mt-10 flex justify-center" id="radar-container">
            <RadarChart items={allRadarItems} />
          </div>
          {allTags.length > 0 && (
            <div class="mt-10 flex flex-wrap justify-center gap-3" id="tag-filter-container">
              {allTags.map((tag) => (
                <button
                  type="button"
                  class="tag-filter inline-flex items-center rounded-xl bg-primary-100 px-4 py-1 text-sm/6 font-medium text-primary-700 hover:bg-primary-200 transition-colors cursor-pointer"
                  data-tag={tag}
                >
                  #{tag}
                </button>
              ))}
            </div>
          )}
          <div class="mt-16 max-w-7xl text-base/7">
            <ComponentRenderer components={radarPage.components} />
          </div>
        </div>
      </div>
    </div>
  </Container>
</Layout>

<script is:inline define:vars={{ allRadarItems }}>
  (function() {
    let selectedTag = null;

    const initTagFiltering = () => {
      console.log('Initializing tag filtering...');
      const tagButtons = document.querySelectorAll('.tag-filter');
      const radarContainer = document.getElementById('radar-container');

      console.log('Found tag buttons:', tagButtons.length);
      console.log('Radar container:', radarContainer);

      if (!radarContainer) {
        console.warn('Radar container not found!');
        return;
      }

      tagButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tag = button.getAttribute('data-tag');
          console.log('Tag clicked:', tag);

          // Toggle tag selection
          if (selectedTag === tag) {
            selectedTag = null;
            // Reset all buttons
            tagButtons.forEach(btn => {
              btn.classList.remove('bg-primary-600', 'text-white');
              btn.classList.add('bg-primary-100', 'text-primary-700');
            });
            // Show all items
            filterRadarItems(null);
          } else {
            selectedTag = tag;
            // Update button states
            tagButtons.forEach(btn => {
              if (btn.getAttribute('data-tag') === tag) {
                btn.classList.remove('bg-primary-100', 'text-primary-700');
                btn.classList.add('bg-primary-600', 'text-white');
              } else {
                btn.classList.remove('bg-primary-600', 'text-white');
                btn.classList.add('bg-primary-100', 'text-primary-700');
              }
            });
            // Filter items
            filterRadarItems(tag);
          }
        });
      });
    };

    const filterRadarItems = (tag) => {
      console.log('Filtering radar items by tag:', tag);
      const radarItems = document.querySelectorAll('.radar-item');
      console.log('Found radar items:', radarItems.length);
      console.log('All radar items data:', allRadarItems);

      radarItems.forEach((item, index) => {
        const link = item.querySelector('a');
        if (!link) {
          console.warn('No link found in radar item', index);
          return;
        }

        const href = link.getAttribute('href');
        const slug = href?.replace('/technology-radar/', '');
        console.log(`Item ${index}: href=${href}, slug=${slug}`);

        // Find the corresponding radar item data
        const itemData = allRadarItems.find(ri => ri.slug === slug);

        if (!itemData) {
          console.warn('No data found for slug:', slug);
          return;
        }

        console.log(`Item ${index} data:`, itemData.title, 'tags:', itemData.tags);

        if (!tag) {
          // Show all items
          item.setAttribute('style', 'transition: opacity 0.3s ease; opacity: 1; pointer-events: auto;');
          console.log(`Showing item ${index}`);
        } else {
          // Check if item has the selected tag
          const hasTag = itemData.tags?.some(t => t.title === tag);
          console.log(`Item ${index} has tag ${tag}:`, hasTag);
          if (hasTag) {
            item.setAttribute('style', 'transition: opacity 0.3s ease; opacity: 1; pointer-events: auto;');
            console.log(`Showing item ${index}`);
          } else {
            item.setAttribute('style', 'transition: opacity 0.3s ease; opacity: 0.2; pointer-events: none;');
            console.log(`Hiding item ${index}`);
          }
        }
      });
    };

    // Initialize on page load
    document.addEventListener('astro:page-load', initTagFiltering);

    // Also initialize immediately in case the event already fired
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initTagFiltering();
    } else {
      document.addEventListener('DOMContentLoaded', initTagFiltering);
    }
  })();
</script>
