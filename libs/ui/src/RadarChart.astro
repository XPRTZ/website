---
import RadarQuadrant from "./RadarQuadrant.astro";
import RadarQuadrantItemList from "./RadarQuadrantItemList.astro";
import type { RadarItem, RadarItemWithNumber } from "@xprtz/cms";

interface Props {
  /**
   * Array of radar items to display on the chart
   */
  items?: RadarItem[];

  /**
   * Size of each quadrant in pixels
   */
  quadrantSize?: number;
}

const { items = [], quadrantSize = 400 } = Astro.props;

// Margin between quadrants
const margin = 20;

// Define colors for each quadrant
const quadrantColors = {
  Techniques: "#3b82f6", // blue
  Tools: "#10b981", // green
  Platforms: "#f59e0b", // amber
  "Languages & Frameworks": "#ef4444", // red
};

// Dutch translations for quadrant names
const quadrantTranslations = {
  Techniques: "Technieken",
  Tools: "Tools",
  Platforms: "Platformen",
  "Languages & Frameworks": "Talen & Frameworks",
};

// Add numbers to items and group by quadrant
const itemsWithNumbers: RadarItemWithNumber[] = items.map((item, index) => ({
  ...item,
  number: index + 1,
}));

const itemsByQuadrant = {
  Techniques: itemsWithNumbers.filter((item) => item.quadrant === "Techniques"),
  Tools: itemsWithNumbers.filter((item) => item.quadrant === "Tools"),
  Platforms: itemsWithNumbers.filter((item) => item.quadrant === "Platforms"),
  "Languages & Frameworks": itemsWithNumbers.filter(
    (item) => item.quadrant === "Languages & Frameworks"
  ),
};

// Calculate total size
const totalWidth = quadrantSize * 2 + margin;
const totalHeight = quadrantSize * 2 + margin;

// Ring labels
const ringLabels = ["Adopt", "Trial", "Assess", "Hold"];
const ringRadii = [0.25, 0.5, 0.75, 1.0]; // Percentages of quadrant size

// Quadrant labels and their positions
const quadrantLabels = [
  { name: "Tools", displayName: "Tools", position: "top-left" },
  { name: "Techniques", displayName: "Technieken", position: "top-right" },
  { name: "Platforms", displayName: "Platformen", position: "bottom-left" },
  { name: "Languages & Frameworks", displayName: "Talen &<br/>Frameworks", position: "bottom-right" },
];
---

<div class="radar-chart-wrapper">
  <div
    class="radar-chart-container"
    style={`width: ${totalWidth}px; height: ${totalHeight}px;`}
  >
    <div
      class="relative radar-chart"
      style={`width: ${totalWidth}px; height: ${totalHeight}px;`}
    >
      <!-- Quadrants Grid -->
      <div class="grid grid-cols-2 grid-rows-2" style={`gap: ${margin}px;`}>
        <!-- Top Left: Position 1 (90-180째) - Tools -->
        <div
          class="flex justify-end items-end quadrant-wrapper transition-opacity duration-300"
          data-quadrant="tools"
        >
          <RadarQuadrant
            position={1}
            color={quadrantColors["Tools"]}
            size={quadrantSize}
            items={itemsByQuadrant["Tools"]}
          />
        </div>

        <!-- Top Right: Position 0 (0-90째) - Techniques -->
        <div
          class="flex justify-start items-end quadrant-wrapper transition-opacity duration-300"
          data-quadrant="techniques"
        >
          <RadarQuadrant
            position={0}
            color={quadrantColors["Techniques"]}
            size={quadrantSize}
            items={itemsByQuadrant["Techniques"]}
          />
        </div>

        <!-- Bottom Left: Position 2 (180-270째) - Platforms -->
        <div
          class="flex justify-end items-start quadrant-wrapper transition-opacity duration-300"
          data-quadrant="platforms"
        >
          <RadarQuadrant
            position={2}
            color={quadrantColors["Platforms"]}
            size={quadrantSize}
            items={itemsByQuadrant["Platforms"]}
          />
        </div>

        <!-- Bottom Right: Position 3 (270-360째) - Languages & Frameworks -->
        <div
          class="flex justify-start items-start quadrant-wrapper transition-opacity duration-300"
          data-quadrant="frameworks"
        >
          <RadarQuadrant
            position={3}
            color={quadrantColors["Languages & Frameworks"]}
            size={quadrantSize}
            items={itemsByQuadrant["Languages & Frameworks"]}
          />
        </div>
      </div>

      <!-- Ring Labels - Horizontal (between Tools and Platforms - left side) -->
      <div
        class="absolute left-0 flex justify-center items-center ring-labels transition-opacity duration-300"
        data-ring-labels="left"
        style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}
      >
        {
          ringLabels.map((label, index) => {
            const radius = quadrantSize * ringRadii[index];
            const prevRadius =
              index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
            const ringCenter = prevRadius + (radius - prevRadius) / 2;

            return (
              <div
                class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
                style={`left: ${quadrantSize - ringCenter}px; height: ${margin}px;`}
              >
                {label}
              </div>
            );
          })
        }
      </div>

      <!-- Ring Labels - Horizontal (between Techniques and Languages & Frameworks - right side) -->
      <div
        class="absolute right-0 flex justify-center items-center ring-labels transition-opacity duration-300"
        data-ring-labels="right"
        style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}
      >
        {
          ringLabels.map((label, index) => {
            const radius = quadrantSize * ringRadii[index];
            const prevRadius =
              index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
            const ringCenter = prevRadius + (radius - prevRadius) / 2;

            return (
              <div
                class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
                style={`left: ${ringCenter}px; height: ${margin}px;`}
              >
                {label}
              </div>
            );
          })
        }
      </div>

      <!-- Quadrant Labels in Corners -->
      {
        quadrantLabels.map((quadrant, index) => {
          let positionStyle = "";
          let textAlign = "";
          let quadrantKey = "";

          if (quadrant.position === "top-left") {
            positionStyle = `top: 0; left: 0;`;
            textAlign = "text-left";
            quadrantKey = "tools";
          } else if (quadrant.position === "top-right") {
            positionStyle = `top: 0; right: 0;`;
            textAlign = "text-right";
            quadrantKey = "techniques";
          } else if (quadrant.position === "bottom-left") {
            positionStyle = `bottom: 0; left: 0;`;
            textAlign = "text-left";
            quadrantKey = "platforms";
          } else {
            positionStyle = `bottom: 0; right: 0;`;
            textAlign = "text-right";
            quadrantKey = "frameworks";
          }

          // Get the color using the name property
          const colorKey = quadrant.name;

          return (
            <div
              class={`absolute text-lg font-bold ${textAlign} quadrant-label transition-opacity duration-300`}
              data-label-quadrant={quadrantKey}
              style={`${positionStyle} padding: 8px; color: ${quadrantColors[colorKey as keyof typeof quadrantColors]};`}
              set:html={quadrant.displayName}
            />
          );
        })
      }
    </div>
  </div>

  <!-- Quadrant Item Lists (hidden by default) -->
  <RadarQuadrantItemList
    items={itemsByQuadrant["Tools"]}
    quadrantName={quadrantTranslations["Tools"]}
    color={quadrantColors["Tools"]}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Techniques"]}
    quadrantName={quadrantTranslations["Techniques"]}
    color={quadrantColors["Techniques"]}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Platforms"]}
    quadrantName={quadrantTranslations["Platforms"]}
    color={quadrantColors["Platforms"]}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Languages & Frameworks"]}
    quadrantName={quadrantTranslations["Languages & Frameworks"]}
    color={quadrantColors["Languages & Frameworks"]}
  />
</div>

<style>
  .radar-chart-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    position: relative;
  }

  .radar-chart-container {
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .radar-chart-wrapper.list-visible .radar-chart-container {
    transform: translateX(-200px);
  }

  /* Position item lists absolutely to prevent layout jump */
  .radar-chart-wrapper :global(.quadrant-item-list) {
    position: absolute;
    left: calc(50% + 220px);
    top: 0;
  }

  .radar-chart.hovering .quadrant-wrapper {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-wrapper.active {
    opacity: 1;
  }

  .radar-chart.hovering .quadrant-label {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-label.active {
    opacity: 1;
  }

  /* Zoom functionality */
  .quadrant-wrapper {
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
    position: relative;
  }

  .radar-chart.zoomed .quadrant-wrapper {
    opacity: 0;
    pointer-events: none;
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1.75) translate(0, 0);
    z-index: 10;
  }

  /* Position adjustments for each quadrant when zoomed */
  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="tools"] {
    transform: scale(1.75) translate(25%, 25%);
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="techniques"] {
    transform: scale(1.75) translate(-25%, 25%);
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="platforms"] {
    transform: scale(1.75) translate(25%, calc(-25% - 15px));
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="frameworks"] {
    transform: scale(1.75) translate(-25%, calc(-25% - 15px));
  }

  .radar-chart.zoomed .quadrant-label {
    display: none;
  }

  /* Ring labels positioning and transitions */
  .ring-labels {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  /* Hide ring labels by default when zoomed */
  .radar-chart.zoomed .ring-labels {
    opacity: 0;
    pointer-events: none;
  }

  /* Show and transform ring labels for Tools quadrant (top-left) */
  .radar-chart.zoomed.zoom-tools .ring-labels[data-ring-labels="left"] {
    opacity: 1;
    transform: scale(1.75) translate(25%, 190px);
  }

  /* Show and transform ring labels for Platforms quadrant (bottom-left) */
  .radar-chart.zoomed.zoom-platforms .ring-labels[data-ring-labels="left"] {
    opacity: 1;
    transform: scale(1.75) translate(25%, -205px);
  }

  /* Show and transform ring labels for Techniques quadrant (top-right) */
  .radar-chart.zoomed.zoom-techniques .ring-labels[data-ring-labels="right"] {
    opacity: 1;
    transform: scale(1.75) translate(-25%, 190px);
  }

  /* Show and transform ring labels for Frameworks quadrant (bottom-right) */
  .radar-chart.zoomed.zoom-frameworks .ring-labels[data-ring-labels="right"] {
    opacity: 1;
    transform: scale(1.75) translate(-25%, -205px);
  }
</style>

<script>
  const initRadarHover = () => {
    const radarCharts = document.querySelectorAll(".radar-chart");

    radarCharts.forEach((chart) => {
      const quadrants = chart.querySelectorAll(".quadrant-wrapper");
      const labels = chart.querySelectorAll(".quadrant-label");

      quadrants.forEach((quadrant) => {
        const quadrantKey = quadrant.getAttribute("data-quadrant");
        const correspondingLabel = Array.from(labels).find(
          (label) => label.getAttribute("data-label-quadrant") === quadrantKey
        );

        const handleMouseEnter = () => {
          // Only show hover effect if not zoomed
          if (!chart.classList.contains("zoomed")) {
            chart.classList.add("hovering");
            quadrant.classList.add("active");
            if (correspondingLabel) {
              correspondingLabel.classList.add("active");
            }
          }
        };

        const handleMouseLeave = () => {
          chart.classList.remove("hovering");
          quadrant.classList.remove("active");
          if (correspondingLabel) {
            correspondingLabel.classList.remove("active");
          }
        };

        quadrant.addEventListener("mouseenter", handleMouseEnter);
        quadrant.addEventListener("mouseleave", handleMouseLeave);
      });
    });
  };

  const initRadarZoom = () => {
    const radarCharts = document.querySelectorAll(".radar-chart");

    radarCharts.forEach((chart) => {
      const quadrants = chart.querySelectorAll(".quadrant-wrapper");
      const labels = chart.querySelectorAll(".quadrant-label");
      const wrapper = chart.closest(".radar-chart-wrapper");

      // Get all quadrant item lists in this wrapper
      const itemLists = wrapper?.querySelectorAll(".quadrant-item-list");

      quadrants.forEach((quadrant) => {
        const quadrantKey = quadrant.getAttribute("data-quadrant");
        const correspondingLabel = Array.from(labels).find(
          (label) => label.getAttribute("data-label-quadrant") === quadrantKey
        );

        quadrant.addEventListener("click", (e) => {
          // Check if the click is on a radar item (link)
          const target = e.target as HTMLElement;
          if (target.closest("a")) {
            // Let the link handle the click
            return;
          }

          // Prevent the click from bubbling
          e.stopPropagation();

          // Toggle zoom state
          const isCurrentlyZoomed = quadrant.classList.contains("zoomed-in");

          if (isCurrentlyZoomed) {
            // Zoom out - hide list and slide wrapper back, then zoom out
            itemLists?.forEach((list) => {
              list.classList.remove("visible");
            });
            wrapper?.classList.remove("list-visible");

            // Wait for list animation to complete before zooming out
            setTimeout(() => {
              chart.classList.remove("zoomed");
              chart.classList.remove(
                "zoom-tools",
                "zoom-techniques",
                "zoom-platforms",
                "zoom-frameworks"
              );
              quadrants.forEach((q) => q.classList.remove("zoomed-in"));
              labels.forEach((l) => l.classList.remove("zoomed-in"));
              itemLists?.forEach((list) => list.classList.add("hidden"));
            }, 400);
          } else {
            // Zoom in - add zoom class to chart and this quadrant
            chart.classList.add("zoomed");
            chart.classList.remove(
              "zoom-tools",
              "zoom-techniques",
              "zoom-platforms",
              "zoom-frameworks"
            );
            chart.classList.add(`zoom-${quadrantKey}`);
            quadrants.forEach((q) => q.classList.remove("zoomed-in"));
            labels.forEach((l) => l.classList.remove("zoomed-in"));
            quadrant.classList.add("zoomed-in");
            if (correspondingLabel) {
              correspondingLabel.classList.add("zoomed-in");
            }

            // Show the corresponding item list after zoom animation completes
            setTimeout(() => {
              // Slide wrapper and show list simultaneously
              wrapper?.classList.add("list-visible");

              itemLists?.forEach((list) => {
                const listQuadrant = list
                  .querySelector("h3")
                  ?.textContent?.trim();
                // Map quadrant keys to Dutch names
                const quadrantNameMap: Record<string, string> = {
                  tools: "Tools",
                  techniques: "Technieken",
                  platforms: "Platformen",
                  frameworks: "Talen & Frameworks",
                };
                const quadrantName = quadrantNameMap[quadrantKey] || "";
                if (listQuadrant === quadrantName) {
                  list.classList.remove("hidden");
                  // Use requestAnimationFrame to ensure display:block is applied before animation
                  requestAnimationFrame(() => {
                    list.classList.add("visible");
                  });
                } else {
                  list.classList.add("hidden");
                  list.classList.remove("visible");
                }
              });
            }, 500); // Wait for zoom animation (500ms) to complete
          }
        });
      });

      // Handle back to radar button clicks
      const backButtons = wrapper?.querySelectorAll(".back-to-radar");
      backButtons?.forEach((button) => {
        button.addEventListener("click", () => {
          // Hide list and slide wrapper back simultaneously
          itemLists?.forEach((list) => {
            list.classList.remove("visible");
          });
          wrapper?.classList.remove("list-visible");

          // Wait for list animation to complete before zooming out
          setTimeout(() => {
            chart.classList.remove("zoomed");
            chart.classList.remove(
              "zoom-tools",
              "zoom-techniques",
              "zoom-platforms",
              "zoom-frameworks"
            );
            quadrants.forEach((q) => q.classList.remove("zoomed-in"));
            labels.forEach((l) => l.classList.remove("zoomed-in"));
            itemLists?.forEach((list) => list.classList.add("hidden"));
          }, 400);
        });
      });
    });
  };

  const initRadar = () => {
    initRadarHover();
    initRadarZoom();
  };

  // Initialize on page load
  document.addEventListener("astro:page-load", initRadar);

  // Also initialize immediately in case the event already fired
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    initRadar();
  }
</script>
