---
import RadarQuadrant from "./RadarQuadrant.astro";
import type { RadarItem } from "@xprtz/cms";

interface Props {
  /**
   * Array of radar items to display on the chart
   */
  items?: RadarItem[];

  /**
   * Size of each quadrant in pixels
   */
  quadrantSize?: number;
}

const { items = [], quadrantSize = 400 } = Astro.props;

// Margin between quadrants
const margin = 20;

// Define colors for each quadrant
const quadrantColors = {
  "Techniques": "#3b82f6",           // blue
  "Tools": "#10b981",                // green
  "Platforms": "#f59e0b",            // amber
  "Languages & Frameworks": "#ef4444" // red
};

// Add numbers to items and group by quadrant
const itemsWithNumbers = items.map((item, index) => ({
  ...item,
  number: index + 1
}));

const itemsByQuadrant = {
  "Techniques": itemsWithNumbers.filter(item => item.quadrant === "Techniques"),
  "Tools": itemsWithNumbers.filter(item => item.quadrant === "Tools"),
  "Platforms": itemsWithNumbers.filter(item => item.quadrant === "Platforms"),
  "Languages & Frameworks": itemsWithNumbers.filter(item => item.quadrant === "Languages & Frameworks")
};

// Calculate total size
const totalWidth = quadrantSize * 2 + margin;
const totalHeight = quadrantSize * 2 + margin;

// Ring labels
const ringLabels = ["Adopt", "Trial", "Assess", "Hold"];
const ringRadii = [0.25, 0.5, 0.75, 1.0]; // Percentages of quadrant size

// Quadrant labels and their positions
const quadrantLabels = [
  { name: "Tools", position: "top-left" },
  { name: "Techniques", position: "top-right" },
  { name: "Platforms", position: "bottom-left" },
  { name: "Languages &<br/>Frameworks", position: "bottom-right" },
];
---

<div class="radar-chart-container" style={`width: ${totalWidth}px; height: ${totalHeight}px;`}>
  <div class="relative radar-chart" style={`width: ${totalWidth}px; height: ${totalHeight}px;`}>
    <!-- Quadrants Grid -->
    <div class="grid grid-cols-2 grid-rows-2" style={`gap: ${margin}px;`}>
    <!-- Top Left: Position 1 (90-180째) - Tools -->
    <div class="flex justify-end items-end quadrant-wrapper transition-opacity duration-300" data-quadrant="tools">
      <RadarQuadrant
        position={1}
        color={quadrantColors["Tools"]}
        size={quadrantSize}
        items={itemsByQuadrant["Tools"]}
      />
    </div>

    <!-- Top Right: Position 0 (0-90째) - Techniques -->
    <div class="flex justify-start items-end quadrant-wrapper transition-opacity duration-300" data-quadrant="techniques">
      <RadarQuadrant
        position={0}
        color={quadrantColors["Techniques"]}
        size={quadrantSize}
        items={itemsByQuadrant["Techniques"]}
      />
    </div>

    <!-- Bottom Left: Position 2 (180-270째) - Platforms -->
    <div class="flex justify-end items-start quadrant-wrapper transition-opacity duration-300" data-quadrant="platforms">
      <RadarQuadrant
        position={2}
        color={quadrantColors["Platforms"]}
        size={quadrantSize}
        items={itemsByQuadrant["Platforms"]}
      />
    </div>

    <!-- Bottom Right: Position 3 (270-360째) - Languages & Frameworks -->
    <div class="flex justify-start items-start quadrant-wrapper transition-opacity duration-300" data-quadrant="frameworks">
      <RadarQuadrant
        position={3}
        color={quadrantColors["Languages & Frameworks"]}
        size={quadrantSize}
        items={itemsByQuadrant["Languages & Frameworks"]}
      />
    </div>
  </div>

  <!-- Ring Labels - Horizontal (between Tools and Platforms - left side) -->
  <div class="absolute left-0 flex justify-center items-center" style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}>
    {ringLabels.map((label, index) => {
      const radius = quadrantSize * ringRadii[index];
      const prevRadius = index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
      const ringCenter = prevRadius + (radius - prevRadius) / 2;

      return (
        <div
          class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
          style={`left: ${quadrantSize - ringCenter}px; height: ${margin}px;`}
        >
          {label}
        </div>
      );
    })}
  </div>

  <!-- Ring Labels - Horizontal (between Techniques and Languages & Frameworks - right side) -->
  <div class="absolute right-0 flex justify-center items-center" style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}>
    {ringLabels.map((label, index) => {
      const radius = quadrantSize * ringRadii[index];
      const prevRadius = index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
      const ringCenter = prevRadius + (radius - prevRadius) / 2;

      return (
        <div
          class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
          style={`left: ${ringCenter}px; height: ${margin}px;`}
        >
          {label}
        </div>
      );
    })}
  </div>

  <!-- Quadrant Labels in Corners -->
  {quadrantLabels.map((quadrant, index) => {
    let positionStyle = "";
    let textAlign = "";
    let quadrantKey = "";

    if (quadrant.position === "top-left") {
      positionStyle = `top: 0; left: 0;`;
      textAlign = "text-left";
      quadrantKey = "tools";
    } else if (quadrant.position === "top-right") {
      positionStyle = `top: 0; right: 0;`;
      textAlign = "text-right";
      quadrantKey = "techniques";
    } else if (quadrant.position === "bottom-left") {
      positionStyle = `bottom: 0; left: 0;`;
      textAlign = "text-left";
      quadrantKey = "platforms";
    } else {
      positionStyle = `bottom: 0; right: 0;`;
      textAlign = "text-right";
      quadrantKey = "frameworks";
    }

    // Get the color - need to handle the modified name with <br/>
    const colorKey = quadrant.name.replace("<br/>", " ");

    return (
      <div
        class={`absolute text-lg font-bold ${textAlign} quadrant-label transition-opacity duration-300`}
        data-label-quadrant={quadrantKey}
        style={`${positionStyle} padding: 8px; color: ${quadrantColors[colorKey as keyof typeof quadrantColors]};`}
        set:html={quadrant.name}
      />
    );
  })}
  </div>
</div>

<style>
  .radar-chart-container {
    margin: 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .radar-chart.hovering .quadrant-wrapper {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-wrapper.active {
    opacity: 1;
  }

  .radar-chart.hovering .quadrant-label {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-label.active {
    opacity: 1;
  }
</style>

<script>
  const initRadarHover = () => {
    const radarCharts = document.querySelectorAll(".radar-chart");

    radarCharts.forEach((chart) => {
      const quadrants = chart.querySelectorAll(".quadrant-wrapper");
      const labels = chart.querySelectorAll(".quadrant-label");

      quadrants.forEach((quadrant) => {
        const quadrantKey = quadrant.getAttribute("data-quadrant");
        const correspondingLabel = Array.from(labels).find(
          (label) => label.getAttribute("data-label-quadrant") === quadrantKey
        );

        const handleMouseEnter = () => {
          chart.classList.add("hovering");
          quadrant.classList.add("active");
          if (correspondingLabel) {
            correspondingLabel.classList.add("active");
          }
        };

        const handleMouseLeave = () => {
          chart.classList.remove("hovering");
          quadrant.classList.remove("active");
          if (correspondingLabel) {
            correspondingLabel.classList.remove("active");
          }
        };

        quadrant.addEventListener("mouseenter", handleMouseEnter);
        quadrant.addEventListener("mouseleave", handleMouseLeave);
      });
    });
  };

  // Initialize on page load
  document.addEventListener("astro:page-load", initRadarHover);

  // Also initialize immediately in case the event already fired
  if (document.readyState === "complete" || document.readyState === "interactive") {
    initRadarHover();
  }
</script>
