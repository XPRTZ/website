---
import RadarQuadrant from "./RadarQuadrant.astro";
import RadarQuadrantItemList from "./RadarQuadrantItemList.astro";
import type { RadarItem, RadarItemWithNumber } from "@xprtz/cms";

interface Props {
  /**
   * Array of radar items to display on the chart
   */
  items?: RadarItem[];

  /**
   * Size of each quadrant in pixels
   */
  quadrantSize?: number;

  /**
   * Slug of the parent page (for back links from radar items)
   */
  parentPageSlug?: string;
}

const { items = [], quadrantSize = 400, parentPageSlug } = Astro.props;

// Margin between quadrants
const margin = 20;

// Define colors for each quadrant
const quadrantColors = {
  Technieken: "#3b82f6", // blue
  Tools: "#10b981", // green
  Platformen: "#f59e0b", // amber
  "Talen & Frameworks": "#ef4444", // red
};

// Add numbers to items and group by quadrant
const itemsWithNumbers: RadarItemWithNumber[] = items.map((item, index) => ({
  ...item,
  number: index + 1,
}));

const itemsByQuadrant = {
  Technieken: itemsWithNumbers.filter((item) => item.quadrant === "Technieken"),
  Tools: itemsWithNumbers.filter((item) => item.quadrant === "Tools"),
  Platformen: itemsWithNumbers.filter((item) => item.quadrant === "Platformen"),
  "Talen & Frameworks": itemsWithNumbers.filter(
    (item) => item.quadrant === "Talen & Frameworks"
  ),
};

// Calculate total size
const totalWidth = quadrantSize * 2 + margin;
const totalHeight = quadrantSize * 2 + margin;

// Ring labels
const ringLabels = ["Adopt", "Trial", "Assess", "Hold"];
const ringRadii = [0.25, 0.5, 0.75, 1.0]; // Percentages of quadrant size

// Quadrant labels and their positions
const quadrantLabels = [
  { name: "Tools", displayName: "Tools", position: "top-left" },
  { name: "Technieken", displayName: "Technieken", position: "top-right" },
  { name: "Platformen", displayName: "Platformen", position: "bottom-left" },
  {
    name: "Talen & Frameworks",
    displayName: "Talen &<br/>Frameworks",
    position: "bottom-right",
  },
];
---

<div class="radar-chart-wrapper">
  <div
    class="radar-chart-container"
    style={`width: ${totalWidth}px; height: ${totalHeight}px;`}
  >
    <div
      class="relative radar-chart"
      style={`width: ${totalWidth}px; height: ${totalHeight}px;`}
    >
      <!-- Quadrants Grid -->
      <div class="grid grid-cols-2 grid-rows-2" style={`gap: ${margin}px;`}>
        <!-- Top Left: Position 1 (90-180째) - Tools -->
        <div
          class="flex justify-end items-end quadrant-wrapper transition-opacity duration-300"
          data-quadrant="tools"
        >
          <RadarQuadrant
            position={1}
            color={quadrantColors["Tools"]}
            size={quadrantSize}
            items={itemsByQuadrant["Tools"]}
            parentPageSlug={parentPageSlug}
          />
        </div>

        <!-- Top Right: Position 0 (0-90째) - Technieken -->
        <div
          class="flex justify-start items-end quadrant-wrapper transition-opacity duration-300"
          data-quadrant="techniques"
        >
          <RadarQuadrant
            position={0}
            color={quadrantColors["Technieken"]}
            size={quadrantSize}
            items={itemsByQuadrant["Technieken"]}
            parentPageSlug={parentPageSlug}
          />
        </div>

        <!-- Bottom Left: Position 2 (180-270째) - Platformen -->
        <div
          class="flex justify-end items-start quadrant-wrapper transition-opacity duration-300"
          data-quadrant="platforms"
        >
          <RadarQuadrant
            position={2}
            color={quadrantColors["Platformen"]}
            size={quadrantSize}
            items={itemsByQuadrant["Platformen"]}
            parentPageSlug={parentPageSlug}
          />
        </div>

        <!-- Bottom Right: Position 3 (270-360째) - Talen & Frameworks -->
        <div
          class="flex justify-start items-start quadrant-wrapper transition-opacity duration-300"
          data-quadrant="frameworks"
        >
          <RadarQuadrant
            position={3}
            color={quadrantColors["Talen & Frameworks"]}
            size={quadrantSize}
            items={itemsByQuadrant["Talen & Frameworks"]}
            parentPageSlug={parentPageSlug}
          />
        </div>
      </div>

      <!-- Ring Labels - Horizontal (between Tools and Platforms - left side) -->
      <div
        class="absolute left-0 flex justify-center items-center ring-labels transition-opacity duration-300"
        data-ring-labels="left"
        style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}
      >
        {
          ringLabels.map((label, index) => {
            const radius = quadrantSize * ringRadii[index];
            const prevRadius =
              index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
            const ringCenter = prevRadius + (radius - prevRadius) / 2;

            return (
              <div
                class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
                style={`left: ${quadrantSize - ringCenter}px; height: ${margin}px;`}
              >
                {label}
              </div>
            );
          })
        }
      </div>

      <!-- Ring Labels - Horizontal (between Techniques and Languages & Frameworks - right side) -->
      <div
        class="absolute right-0 flex justify-center items-center ring-labels transition-opacity duration-300"
        data-ring-labels="right"
        style={`top: ${quadrantSize}px; height: ${margin}px; width: ${quadrantSize}px;`}
      >
        {
          ringLabels.map((label, index) => {
            const radius = quadrantSize * ringRadii[index];
            const prevRadius =
              index > 0 ? quadrantSize * ringRadii[index - 1] : 0;
            const ringCenter = prevRadius + (radius - prevRadius) / 2;

            return (
              <div
                class="absolute text-xs font-bold text-gray-600 flex items-center -translate-x-1/2"
                style={`left: ${ringCenter}px; height: ${margin}px;`}
              >
                {label}
              </div>
            );
          })
        }
      </div>

      <!-- Quadrant Labels in Corners -->
      {
        quadrantLabels.map((quadrant, index) => {
          let positionStyle = "";
          let textAlign = "";
          let quadrantKey = "";

          if (quadrant.position === "top-left") {
            positionStyle = `top: 0; left: 0;`;
            textAlign = "text-left";
            quadrantKey = "tools";
          } else if (quadrant.position === "top-right") {
            positionStyle = `top: 0; right: 0;`;
            textAlign = "text-right";
            quadrantKey = "techniques";
          } else if (quadrant.position === "bottom-left") {
            positionStyle = `bottom: 0; left: 0;`;
            textAlign = "text-left";
            quadrantKey = "platforms";
          } else {
            positionStyle = `bottom: 0; right: 0;`;
            textAlign = "text-right";
            quadrantKey = "frameworks";
          }

          // Get the color using the name property
          const colorKey = quadrant.name;

          return (
            <div
              class={`absolute text-lg font-bold ${textAlign} quadrant-label transition-opacity duration-300`}
              data-label-quadrant={quadrantKey}
              style={`${positionStyle} padding: 8px; color: ${quadrantColors[colorKey as keyof typeof quadrantColors]};`}
              set:html={quadrant.displayName}
            />
          );
        })
      }
    </div>
  </div>

  <!-- Quadrant Rectangles for mobile (hidden by default, shown below 870px) -->
  <div class="quadrant-rectangles" style="display: none;">
    <div
      class="quadrant-rect"
      data-quadrant-rect="tools"
      style={`background-color: ${quadrantColors["Tools"]};`}
    >
      Tools
    </div>
    <div
      class="quadrant-rect"
      data-quadrant-rect="techniques"
      style={`background-color: ${quadrantColors["Technieken"]};`}
    >
      Technieken
    </div>
    <div
      class="quadrant-rect"
      data-quadrant-rect="platforms"
      style={`background-color: ${quadrantColors["Platformen"]};`}
    >
      Platformen
    </div>
    <div
      class="quadrant-rect"
      data-quadrant-rect="frameworks"
      style={`background-color: ${quadrantColors["Talen & Frameworks"]};`}
    >
      Talen & Frameworks
    </div>
  </div>

  <!-- Quadrant Item Lists (hidden by default) -->
  <RadarQuadrantItemList
    items={itemsByQuadrant["Tools"]}
    quadrantName="Tools"
    color={quadrantColors["Tools"]}
    parentPageSlug={parentPageSlug}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Technieken"]}
    quadrantName="Technieken"
    color={quadrantColors["Technieken"]}
    parentPageSlug={parentPageSlug}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Platformen"]}
    quadrantName="Platformen"
    color={quadrantColors["Platformen"]}
    parentPageSlug={parentPageSlug}
  />
  <RadarQuadrantItemList
    items={itemsByQuadrant["Talen & Frameworks"]}
    quadrantName="Talen & Frameworks"
    color={quadrantColors["Talen & Frameworks"]}
    parentPageSlug={parentPageSlug}
  />
</div>

<style>
  .radar-chart-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    position: relative;
    width: 100%;
    max-width: 100%;
    --fade-out-duration: 300ms;
  }

  .radar-chart-container {
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .radar-chart-wrapper.list-visible .radar-chart-container {
    transform: translateX(-200px);
  }

  /* Position item lists absolutely to prevent layout jump */
  .radar-chart-wrapper :global(.quadrant-item-list) {
    position: absolute;
    left: calc(50% + 220px);
    top: 0;
  }

  @media (max-width: 1280px) {
    .radar-chart-wrapper :global(.quadrant-item-list) {
      left: 57vw;
    }
  }

  @media (max-width: 1090px) {
    .radar-chart-wrapper.list-visible .radar-chart-container {
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--fade-out-duration) cubic-bezier(0.4, 0, 0.2, 1);
    }

    .radar-chart-wrapper.list-animation-complete .radar-chart-container {
      display: none;
    }

    .radar-chart-wrapper.list-animation-complete :global(.quadrant-item-list) {
      position: static;
    }

    .radar-chart-wrapper :global(.quadrant-item-list) {
      left: auto;
      margin: 0;
      padding-left: 0;
      padding-right: 0;
      width: 100%;
      max-width: 100%;
    }

    .radar-chart-wrapper :global(.quadrant-item-list > div) {
      width: 100%;
      max-width: 100%;
    }

    .radar-chart-wrapper.list-visible .radar-chart-container {
      transform: none;
    }
  }

  @media (max-width: 870px) {
    .radar-chart-container {
      display: none;
    }

    .quadrant-rectangles {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 0 auto;
    }

    .radar-chart-wrapper.list-visible .quadrant-rectangles {
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--fade-out-duration) cubic-bezier(0.4, 0, 0.2, 1);
    }

    .radar-chart-wrapper.list-animation-complete .quadrant-rectangles {
      display: none !important;
    }

    .radar-chart-wrapper.list-animation-complete :global(.quadrant-item-list) {
      position: static;
    }

    .quadrant-rect {
      aspect-ratio: 1;
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.125rem;
      font-weight: bold;
      color: white;
    }

    .quadrant-rect:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Hover dim effect for rectangles */
    .quadrant-rectangles.hovering .quadrant-rect {
      opacity: 0.5;
    }

    .quadrant-rectangles.hovering .quadrant-rect.active {
      opacity: 1;
    }

    /* Zoom effect for rectangles */
    .quadrant-rectangles.zoomed .quadrant-rect {
      opacity: 0;
      pointer-events: none;
    }

    .quadrant-rectangles.zoomed .quadrant-rect.zoomed-in {
      opacity: 1;
      pointer-events: auto;
    }

    /* Transform origins for each corner */
    .quadrant-rect[data-quadrant-rect="tools"] {
      transform-origin: top left;
    }

    .quadrant-rect[data-quadrant-rect="techniques"] {
      transform-origin: top right;
    }

    .quadrant-rect[data-quadrant-rect="platforms"] {
      transform-origin: bottom left;
    }

    .quadrant-rect[data-quadrant-rect="frameworks"] {
      transform-origin: bottom right;
    }

    /* Zoom transformations - scale to fill entire grid (2x2 + gap) */
    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="tools"] {
      transform: scale(2.05);
    }

    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="techniques"] {
      transform: scale(2.05);
    }

    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="platforms"] {
      transform: scale(2.05);
    }

    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="frameworks"] {
      transform: scale(2.05);
    }
  }

  @media (max-width: 360px) {
    .quadrant-rectangles {
      grid-template-columns: 1fr;
    }

    /* Disable zoom animation in single column layout */
    .quadrant-rectangles.zoomed .quadrant-rect {
      opacity: 0.3 !important;
      pointer-events: auto !important;
      transition: opacity 0.3s ease-in-out;
    }

    .quadrant-rectangles.zoomed .quadrant-rect.zoomed-in {
      transform: none !important;
      opacity: 1 !important;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5), 0 0 20px rgba(0, 0, 0, 0.3);
      animation: pulse-subtle 0.5s ease-in-out;
    }

    /* Override all specific quadrant zoom transforms */
    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="tools"],
    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="techniques"],
    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="platforms"],
    .quadrant-rectangles.zoomed
      .quadrant-rect.zoomed-in[data-quadrant-rect="frameworks"] {
      transform: none !important;
    }

    /* Disable hover effects in single column */
    .quadrant-rectangles.hovering .quadrant-rect {
      opacity: 1 !important;
    }

    /* Subtle pulse animation */
    @keyframes pulse-subtle {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7), 0 0 20px rgba(0, 0, 0, 0.3);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.3), 0 0 25px rgba(0, 0, 0, 0.4);
      }
      100% {
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5), 0 0 20px rgba(0, 0, 0, 0.3);
      }
    }
  }

  .radar-chart.hovering .quadrant-wrapper {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-wrapper.active {
    opacity: 1;
  }

  .radar-chart.hovering .quadrant-label {
    opacity: 0.5;
  }

  .radar-chart.hovering .quadrant-label.active {
    opacity: 1;
  }

  /* Zoom functionality */
  .quadrant-wrapper {
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
    position: relative;
  }

  .radar-chart.zoomed .quadrant-wrapper {
    opacity: 0;
    pointer-events: none;
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1.75) translate(0, 0);
  }

  /* Position adjustments for each quadrant when zoomed */
  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="tools"] {
    transform: scale(1.75) translate(25%, 25%);
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="techniques"] {
    transform: scale(1.75) translate(-25%, 25%);
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="platforms"] {
    transform: scale(1.75) translate(25%, calc(-25% - 15px));
  }

  .radar-chart.zoomed .quadrant-wrapper.zoomed-in[data-quadrant="frameworks"] {
    transform: scale(1.75) translate(-25%, calc(-25% - 15px));
  }

  .radar-chart.zoomed .quadrant-label {
    display: none;
  }

  /* Ring labels positioning and transitions */
  .ring-labels {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  /* Hide ring labels by default when zoomed */
  .radar-chart.zoomed .ring-labels {
    opacity: 0;
    pointer-events: none;
  }

  /* Show and transform ring labels for Tools quadrant (top-left) */
  .radar-chart.zoomed.zoom-tools .ring-labels[data-ring-labels="left"] {
    opacity: 1;
    transform: scale(1.75) translate(25%, 190px);
  }

  /* Show and transform ring labels for Platforms quadrant (bottom-left) */
  .radar-chart.zoomed.zoom-platforms .ring-labels[data-ring-labels="left"] {
    opacity: 1;
    transform: scale(1.75) translate(25%, -205px);
  }

  /* Show and transform ring labels for Techniques quadrant (top-right) */
  .radar-chart.zoomed.zoom-techniques .ring-labels[data-ring-labels="right"] {
    opacity: 1;
    transform: scale(1.75) translate(-25%, 190px);
  }

  /* Show and transform ring labels for Frameworks quadrant (bottom-right) */
  .radar-chart.zoomed.zoom-frameworks .ring-labels[data-ring-labels="right"] {
    opacity: 1;
    transform: scale(1.75) translate(-25%, -205px);
  }
</style>

<script>
  const initRadarHover = () => {
    const radarCharts = document.querySelectorAll(".radar-chart");

    radarCharts.forEach((chart) => {
      const quadrants = chart.querySelectorAll(".quadrant-wrapper");
      const labels = chart.querySelectorAll(".quadrant-label");

      quadrants.forEach((quadrant) => {
        const quadrantKey = quadrant.getAttribute("data-quadrant");
        const correspondingLabel = Array.from(labels).find(
          (label) => label.getAttribute("data-label-quadrant") === quadrantKey
        );

        const handleMouseEnter = () => {
          // Only show hover effect if not zoomed
          if (!chart.classList.contains("zoomed")) {
            chart.classList.add("hovering");
            quadrant.classList.add("active");
            if (correspondingLabel) {
              correspondingLabel.classList.add("active");
            }
          }
        };

        const handleMouseLeave = () => {
          chart.classList.remove("hovering");
          quadrant.classList.remove("active");
          if (correspondingLabel) {
            correspondingLabel.classList.remove("active");
          }
        };

        quadrant.addEventListener("mouseenter", handleMouseEnter);
        quadrant.addEventListener("mouseleave", handleMouseLeave);
      });
    });
  };

  const initRadarZoom = () => {
    const radarCharts = document.querySelectorAll(".radar-chart");

    radarCharts.forEach((chart) => {
      const quadrants = chart.querySelectorAll(".quadrant-wrapper");
      const labels = chart.querySelectorAll(".quadrant-label");
      const wrapper = chart.closest(".radar-chart-wrapper");

      // Get fade-out duration from CSS variable
      const fadeOutDuration = wrapper
        ? parseInt(
            getComputedStyle(wrapper)
              .getPropertyValue("--fade-out-duration")
              .replace("ms", "")
          )
        : 300;

      // Get all quadrant item lists in this wrapper
      const itemLists = wrapper?.querySelectorAll(".quadrant-item-list");

      quadrants.forEach((quadrant) => {
        const quadrantKey = quadrant.getAttribute("data-quadrant");
        const correspondingLabel = Array.from(labels).find(
          (label) => label.getAttribute("data-label-quadrant") === quadrantKey
        );

        quadrant.addEventListener("click", (e) => {
          // Check if the click is on a radar item (link)
          const target = e.target as HTMLElement;
          if (target.closest("a")) {
            // Let the link handle the click
            return;
          }

          // Prevent the click from bubbling
          e.stopPropagation();

          // Toggle zoom state
          const isCurrentlyZoomed = quadrant.classList.contains("zoomed-in");

          if (isCurrentlyZoomed) {
            // Zoom out - hide list and slide wrapper back, then zoom out
            itemLists?.forEach((list) => {
              list.classList.remove("visible");
            });
            wrapper?.classList.remove("list-visible");
            wrapper?.classList.remove("list-animation-complete");

            // Wait for list animation to complete before zooming out
            setTimeout(() => {
              chart.classList.remove("zoomed");
              chart.classList.remove(
                "zoom-tools",
                "zoom-techniques",
                "zoom-platforms",
                "zoom-frameworks"
              );
              quadrants.forEach((q) => q.classList.remove("zoomed-in"));
              labels.forEach((l) => l.classList.remove("zoomed-in"));
              itemLists?.forEach((list) => list.classList.add("hidden"));
            }, 400);
          } else {
            // Zoom in - add zoom class to chart and this quadrant
            chart.classList.add("zoomed");
            chart.classList.remove(
              "zoom-tools",
              "zoom-techniques",
              "zoom-platforms",
              "zoom-frameworks"
            );
            chart.classList.add(`zoom-${quadrantKey}`);
            quadrants.forEach((q) => q.classList.remove("zoomed-in"));
            labels.forEach((l) => l.classList.remove("zoomed-in"));
            quadrant.classList.add("zoomed-in");
            if (correspondingLabel) {
              correspondingLabel.classList.add("zoomed-in");
            }

            // Show the corresponding item list after zoom animation completes
            setTimeout(() => {
              // Slide wrapper and show list simultaneously
              wrapper?.classList.add("list-visible");

              // Add list-animation-complete after fade-out completes
              setTimeout(() => {
                wrapper?.classList.add("list-animation-complete");
              }, fadeOutDuration);

              itemLists?.forEach((list) => {
                const listQuadrant = list
                  .querySelector("h3")
                  ?.textContent?.trim();
                // Map quadrant keys to Dutch names
                const quadrantNameMap: Record<string, string> = {
                  tools: "Tools",
                  techniques: "Technieken",
                  platforms: "Platformen",
                  frameworks: "Talen & Frameworks",
                };
                const quadrantName = quadrantNameMap[quadrantKey] || "";
                if (listQuadrant === quadrantName) {
                  list.classList.remove("hidden");
                  // Use requestAnimationFrame to ensure display:block is applied before animation
                  requestAnimationFrame(() => {
                    list.classList.add("visible");
                  });
                } else {
                  list.classList.add("hidden");
                  list.classList.remove("visible");
                }
              });
            }, 500); // Wait for zoom animation (500ms) to complete
          }
        });
      });

      // Handle back to radar button clicks
      const backButtons = wrapper?.querySelectorAll(".back-to-radar");
      backButtons?.forEach((button) => {
        button.addEventListener("click", () => {
          // Hide list and slide wrapper back simultaneously
          itemLists?.forEach((list) => {
            list.classList.remove("visible");
          });
          wrapper?.classList.remove("list-visible");
          wrapper?.classList.remove("list-animation-complete");

          // Wait for list animation to complete before zooming out
          setTimeout(() => {
            chart.classList.remove("zoomed");
            chart.classList.remove(
              "zoom-tools",
              "zoom-techniques",
              "zoom-platforms",
              "zoom-frameworks"
            );
            quadrants.forEach((q) => q.classList.remove("zoomed-in"));
            labels.forEach((l) => l.classList.remove("zoomed-in"));
            itemLists?.forEach((list) => list.classList.add("hidden"));
          }, 400);
        });
      });
    });
  };

  const initQuadrantRectangles = () => {
    const wrappers = document.querySelectorAll(".radar-chart-wrapper");

    wrappers.forEach((wrapper) => {
      // Get fade-out duration from CSS variable
      const fadeOutDuration = parseInt(
        getComputedStyle(wrapper)
          .getPropertyValue("--fade-out-duration")
          .replace("ms", "")
      );

      const rectangles = wrapper.querySelectorAll(".quadrant-rect");
      const rectanglesContainer = wrapper.querySelector(".quadrant-rectangles");
      const itemLists = wrapper.querySelectorAll(".quadrant-item-list");
      const chart = wrapper.querySelector(".radar-chart");
      const quadrants = wrapper.querySelectorAll(".quadrant-wrapper");
      const labels = wrapper.querySelectorAll(".quadrant-label");

      rectangles.forEach((rect) => {
        const quadrantKey = rect.getAttribute("data-quadrant-rect");

        // Hover effects
        const handleMouseEnter = () => {
          // Only show hover effect if not zoomed
          if (!rectanglesContainer?.classList.contains("zoomed")) {
            rectanglesContainer?.classList.add("hovering");
            rect.classList.add("active");
          }
        };

        const handleMouseLeave = () => {
          rectanglesContainer?.classList.remove("hovering");
          rect.classList.remove("active");
        };

        rect.addEventListener("mouseenter", handleMouseEnter);
        rect.addEventListener("mouseleave", handleMouseLeave);

        rect.addEventListener("click", () => {
          // Check if currently zoomed
          const isCurrentlyZoomed = rect.classList.contains("zoomed-in");

          if (isCurrentlyZoomed) {
            // Zoom out - hide list and remove zoom
            itemLists?.forEach((list) => {
              list.classList.remove("visible");
            });
            wrapper.classList.remove("list-visible");
            wrapper.classList.remove("list-animation-complete");

            // Wait for list animation to complete before zooming out
            setTimeout(() => {
              rectanglesContainer?.classList.remove("zoomed");
              rectangles.forEach((r) => r.classList.remove("zoomed-in"));

              // Also clear radar chart zoom state
              if (chart) {
                chart.classList.remove("zoomed");
                chart.classList.remove(
                  "zoom-tools",
                  "zoom-techniques",
                  "zoom-platforms",
                  "zoom-frameworks"
                );
                quadrants.forEach((q) => q.classList.remove("zoomed-in"));
                labels.forEach((l) => l.classList.remove("zoomed-in"));
              }
            }, 400);
          } else {
            // Zoom in - add zoom class to rectangles container and this rectangle
            rectanglesContainer?.classList.add("zoomed");
            rectangles.forEach((r) => r.classList.remove("zoomed-in"));
            rect.classList.add("zoomed-in");

            // Set up zoom state for the radar chart (for when screen size increases)
            if (chart) {
              chart.classList.add("zoomed");
              chart.classList.remove(
                "zoom-tools",
                "zoom-techniques",
                "zoom-platforms",
                "zoom-frameworks"
              );
              chart.classList.add(`zoom-${quadrantKey}`);

              // Find and zoom the corresponding quadrant
              quadrants.forEach((q) => {
                const qKey = q.getAttribute("data-quadrant");
                if (qKey === quadrantKey) {
                  q.classList.add("zoomed-in");
                } else {
                  q.classList.remove("zoomed-in");
                }
              });

              // Update labels
              labels.forEach((l) => {
                const lKey = l.getAttribute("data-label-quadrant");
                if (lKey === quadrantKey) {
                  l.classList.add("zoomed-in");
                } else {
                  l.classList.remove("zoomed-in");
                }
              });
            }

            // Show the corresponding item list after zoom animation completes
            setTimeout(() => {
              wrapper.classList.add("list-visible");

              // Add list-animation-complete after fade-out completes
              setTimeout(() => {
                wrapper.classList.add("list-animation-complete");
              }, fadeOutDuration);

              itemLists?.forEach((list) => {
                const listQuadrant = list
                  .querySelector("h3")
                  ?.textContent?.trim();
                const quadrantNameMap: Record<string, string> = {
                  tools: "Tools",
                  techniques: "Technieken",
                  platforms: "Platformen",
                  frameworks: "Talen & Frameworks",
                };
                const quadrantName = quadrantNameMap[quadrantKey || ""] || "";
                if (listQuadrant === quadrantName) {
                  list.classList.remove("hidden");
                  requestAnimationFrame(() => {
                    list.classList.add("visible");
                  });
                } else {
                  list.classList.add("hidden");
                  list.classList.remove("visible");
                }
              });
            }, 500); // Wait for zoom animation (500ms) to complete
          }
        });
      });

      // Handle back to radar button clicks for rectangles
      const backButtons = wrapper.querySelectorAll(".back-to-radar");
      backButtons?.forEach((button) => {
        button.addEventListener("click", () => {
          // Hide list
          itemLists?.forEach((list) => {
            list.classList.remove("visible");
          });
          wrapper.classList.remove("list-visible");
          wrapper.classList.remove("list-animation-complete");

          // Wait for list animation to complete before zooming out
          setTimeout(() => {
            rectanglesContainer?.classList.remove("zoomed");
            rectangles.forEach((r) => r.classList.remove("zoomed-in"));

            // Also clear radar chart zoom state
            if (chart) {
              chart.classList.remove("zoomed");
              chart.classList.remove(
                "zoom-tools",
                "zoom-techniques",
                "zoom-platforms",
                "zoom-frameworks"
              );
              quadrants?.forEach((q) => q.classList.remove("zoomed-in"));
              labels?.forEach((l) => l.classList.remove("zoomed-in"));
            }
            itemLists?.forEach((list) => list.classList.add("hidden"));
          }, 400);
        });
      });
    });
  };

  const initItemListHover = () => {
    const wrappers = document.querySelectorAll(".radar-chart-wrapper");

    wrappers.forEach((wrapper) => {
      const itemLists = wrapper.querySelectorAll(".quadrant-item-list");

      itemLists.forEach((list) => {
        const listItems = list.querySelectorAll("li a");

        listItems.forEach((link) => {
          const href = link.getAttribute("href");
          if (!href) return;

          // Extract slug from the link (handle both with and without query params)
          const slug = href.split("?")[0].replace("/radar-items/", "");

          // Find corresponding radar item by slug
          const radarItems = wrapper.querySelectorAll(".radar-item");
          const matchingRadarItem = Array.from(radarItems).find((item) => {
            const itemLink = item.querySelector("a");
            const itemHref = itemLink?.getAttribute("href");
            const itemSlug = itemHref
              ?.split("?")[0]
              .replace("/radar-items/", "");
            return itemSlug === slug;
          });

          if (matchingRadarItem) {
            link.addEventListener("mouseenter", () => {
              matchingRadarItem.classList.add("highlighted");
            });

            link.addEventListener("mouseleave", () => {
              matchingRadarItem.classList.remove("highlighted");
            });
          }
        });
      });
    });
  };

  const initRadar = () => {
    initRadarHover();
    initRadarZoom();
    initQuadrantRectangles();
    initItemListHover();
  };

  // Initialize on page load
  document.addEventListener("astro:page-load", initRadar);

  // Also initialize immediately in case the event already fired
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    initRadar();
  }
</script>
